import random
from games.base_game import BaseGame

class LetterGame(BaseGame):
    """لعبة الحروف - اسئلة تبدأ بحرف معين"""
    
    def __init__(self, line_bot_api, difficulty=3, theme='light'):
        super().__init__(line_bot_api, difficulty=difficulty, theme=theme)
        self.game_name = "حرف"
        self.supports_hint = True
        self.supports_reveal = True
        
        # قاعدة بيانات 100 سؤال مرتبة حسب الحروف
        self.questions_db = {
            "ا": [
                {"q": "من هو اول نبي", "a": ["آدم", "ادم"]},
                {"q": "ما هي عاصمة اليونان", "a": ["أثينا", "اثينا"]},
                {"q": "ما هي عاصمة الجزائر", "a": ["الجزائر"]},
                {"q": "من هو اول خليفة للمسلمين", "a": ["أبو بكر", "ابو بكر"]},
                {"q": "ما هي اكبر قارة في العالم", "a": ["آسيا", "اسيا"]},
                {"q": "ما اطول نهر في العالم", "a": ["النيل", "انيل"]},
                {"q": "ما اكبر محيط في العالم", "a": ["الهادي", "الهادئ"]},
                {"q": "ما لون قميص المنتخب السعودي", "a": ["اخضر"]},
                {"q": "ما اسم الشهر التاسع الهجري", "a": ["رمضان", "ارمضان"]}
            ],
            "ب": [
                {"q": "ما هي عاصمة العراق", "a": ["بغداد"]},
                {"q": "ما هي عاصمة الصين", "a": ["بكين"]},
                {"q": "ما هي عاصمة لبنان", "a": ["بيروت"]},
                {"q": "ما هي عاصمة ألمانيا", "a": ["برلين"]},
                {"q": "ما الحيوان المعروف بتزويدنا بالحليب", "a": ["بقرة"]},
                {"q": "ما اسم اصغر دولة عربية", "a": ["البحرين", "بحرين"]},
                {"q": "ما اسم عاصمة تايلاند", "a": ["بانكوك"]},
                {"q": "ما اللون الذي يدل على النقاء", "a": ["ابيض", "بياض"]},
                {"q": "ما المحيط بين امريكا واوروبا", "a": ["الاطلسي", "باطلسي"]}
            ],
            "ت": [
                {"q": "ما هي عاصمة تونس", "a": ["تونس"]},
                {"q": "ما هي عاصمة تايوان", "a": ["تايبيه", "تايبي"]},
                {"q": "ما هي عاصمة جورجيا", "a": ["تبليسي"]},
                {"q": "ما الحيوان الضخم الذي يعيش في المستنقعات", "a": ["تمساح"]},
                {"q": "ما الفاكهة التي تأتي بألوان مختلفة", "a": ["تفاح"]},
                {"q": "ما اسم الشهر الثاني الميلادي", "a": ["فبراير", "تفبراير"]},
                {"q": "ما اسم عاصمة ايران", "a": ["طهران", "تطهران"]},
                {"q": "ما اسم بحيرة شهيرة في تركيا", "a": ["طوز", "تطوز"]},
                {"q": "ما اسم اول امرأة حصلت على نوبل", "a": ["تيريزا", "تريزا"]}
            ],
            "ج": [
                {"q": "ما هي عاصمة جيبوتي", "a": ["جيبوتي"]},
                {"q": "ما المدينة السعودية على البحر الأحمر", "a": ["جدة"]},
                {"q": "ما الحيوان المعروف بسفينة الصحراء", "a": ["جمل"]},
                {"q": "من الصحابي الذي قاد المسلمين الى الحبشة", "a": ["جعفر"]},
                {"q": "ما اكبر كوكب في المجموعة الشمسية", "a": ["جوبيتر", "المشتري"]},
                {"q": "ما اسم عملة بريطانيا", "a": ["جنيه"]},
                {"q": "ما اسم الفاكهة الاستوائية الشهيرة", "a": ["جوافة"]},
                {"q": "ما اسم النهر الذي يمر بالسودان", "a": ["النيل", "جنيل"]},
                {"q": "ما اسم المسلسل العربي الشهير", "a": ["جراند"]},
                {"q": "ما اسم القارة الجنوبية المتجمدة", "a": ["جنوبية"]}
            ],
            "ح": [
                {"q": "ما المدينة السورية المشهورة بقلعتها", "a": ["حلب"]},
                {"q": "ما المدينة السورية التي يمر بها نهر العاصي", "a": ["حماة"]},
                {"q": "ما المدينة السعودية في شمال المملكة", "a": ["حائل"]},
                {"q": "ما الركن الخامس من اركان الاسلام", "a": ["حج"]},
                {"q": "ما الحيوان العملاق الذي يعيش في المحيطات", "a": ["حوت"]},
                {"q": "ما اسم الطائر الجارح الشهير", "a": ["حدأة"]},
                {"q": "ما اسم الخليفة الراشدي الثالث", "a": ["عثمان", "حعثمان"]},
                {"q": "ما اسم المشروب الساخن المفضل", "a": ["قهوة", "حقهوة"]},
                {"q": "ما اسم البحر بين افريقيا واسيا", "a": ["احمر", "حمر"]}
            ],
            "د": [
                {"q": "ما هي عاصمة ايرلندا", "a": ["دبلن"]},
                {"q": "ما هي عاصمة سوريا", "a": ["دمشق"]},
                {"q": "ما المدينة الاماراتية الشهيرة", "a": ["دبي"]},
                {"q": "ما هي عاصمة قطر", "a": ["دوحة"]},
                {"q": "ما الحيوان الذي يعيش في القطب الشمالي", "a": ["دب"]},
                {"q": "ما اسم الطائر المنزلي الشهير", "a": ["دجاجة"]},
                {"q": "ما اسم العملة الاماراتية", "a": ["درهم"]},
                {"q": "ما اسم الاله الموسيقية المشهورة", "a": ["درامز"]},
                {"q": "ما اسم النبي الذي ابتلعه الحوت", "a": ["يونس", "ديونس"]}
            ],
            "ر": [
                {"q": "ما هي عاصمة ايطاليا", "a": ["روما"]},
                {"q": "ما الدولة الاكبر مساحة في العالم", "a": ["روسيا"]},
                {"q": "ما هي عاصمة ايسلندا", "a": ["ريكيافيك"]},
                {"q": "ما اسم العملة الرسمية في قطر", "a": ["ريال"]},
                {"q": "من ابنة الرسول التي تزوجها عثمان", "a": ["رقية"]},
                {"q": "ما اسم الشهر السابع الميلادي", "a": ["يوليو", "ريوليو"]},
                {"q": "ما اسم المدينة المنورة قديما", "a": ["يثرب", "ريثرب"]},
                {"q": "ما اسم الطائر المشهور بالذكاء", "a": ["غراب", "رغراب"]},
                {"q": "ما اسم الفاكهة الحمراء اللذيذة", "a": ["رمان"]}
            ],
            "س": [
                {"q": "ما الحيوان الزاحف البطيء ذو الصدفة", "a": ["سلحفاة"]},
                {"q": "من الصحابي الذي اشار بحفر الخندق", "a": ["سلمان"]},
                {"q": "ما هي عاصمة السويد", "a": ["ستوكهولم"]},
                {"q": "ما الحيوان الصغير الذي يعيش على الاشجار", "a": ["سنجاب"]},
                {"q": "ما الدولة العربية التي عاصمتها مسقط", "a": ["عمان", "سعمان"]},
                {"q": "ما اسم الكوكب السادس من الشمس", "a": ["زحل", "سزحل"]},
                {"q": "ما اسم الشهر السابع الهجري", "a": ["رجب", "سرجب"]},
                {"q": "ما اسم البحر الذي يقع شمال مصر", "a": ["متوسط", "سمتوسط"]},
                {"q": "ما اسم الجبل المقدس في مكة", "a": ["عرفات", "سعرفات"]}
            ],
            "ع": [
                {"q": "ما المادة الحلوة التي ينتجها النحل", "a": ["عسل"]},
                {"q": "ما العضو في جسم الانسان للرؤية", "a": ["عين"]},
                {"q": "ما هي عاصمة الاردن", "a": ["عمان"]},
                {"q": "ما القدرة على التفكير والتحليل", "a": ["عقل"]},
                {"q": "ما الفاكهة التي تزرع في كروم", "a": ["عنب"]},
                {"q": "ما اسم الشهر العاشر الهجري", "a": ["شوال", "عشوال"]},
                {"q": "ما اسم الخليفة الراشدي الثاني", "a": ["عمر"]},
                {"q": "ما اسم المشروب الذي يصنع من الفواكه", "a": ["عصير"]},
                {"q": "ما اسم الحيوان المفترس الكبير", "a": ["عضاية"]}
            ],
            "ف": [
                {"q": "ما الدولة الاوروبية عاصمتها هلسنكي", "a": ["فنلندا"]},
                {"q": "ما الدولة الاوروبية عاصمتها باريس", "a": ["فرنسا"]},
                {"q": "ما الحيوان البري الاكبر حجما في افريقيا", "a": ["فيل"]},
                {"q": "ما الحيوان الاسرع في العدو", "a": ["فهد"]},
                {"q": "ما الامبراطورية التي امتدت في ايران", "a": ["فارس"]},
                {"q": "ما اسم الشهر الثاني الهجري", "a": ["صفر", "فصفر"]},
                {"q": "ما اسم الفاكهة الحمراء اللذيذة", "a": ["فراولة"]},
                {"q": "ما اسم المعدن الثمين الاصفر", "a": ["ذهب", "فذهب"]},
                {"q": "ما اسم النبي الذي بنى الكعبة", "a": ["ابراهيم", "فابراهيم"]}
            ],
            "ق": [
                {"q": "ما الدولة العربية على الخليج", "a": ["قطر"]},
                {"q": "ما هي عاصمة مصر", "a": ["قاهرة"]},
                {"q": "ما المدينة الجزائرية بجسورها المعلقة", "a": ["قسنطينة"]},
                {"q": "ما اكبر قارة من حيث المساحة", "a": ["آسيا", "قاسيا"]},
                {"q": "ما الكائن البحري الهلامي", "a": ["قنديل"]},
                {"q": "ما اسم الكوكب الاحمر", "a": ["مريخ", "قمريخ"]},
                {"q": "ما اسم المشروب العربي الشهير", "a": ["قهوة"]},
                {"q": "ما اسم الطائر الذي يعيش في البرد", "a": ["بطريق", "قبطريق"]},
                {"q": "ما اسم الشهر الحادي عشر الهجري", "a": ["ذو القعدة", "قعدة"]}
            ],
            "ك": [
                {"q": "ما هي عاصمة ماليزيا", "a": ["كوالالمبور"]},
                {"q": "ما هي عاصمة افغانستان", "a": ["كابول"]},
                {"q": "ما هي عاصمة اوكرانيا", "a": ["كييف"]},
                {"q": "ما هي عاصمة اوغندا", "a": ["كمبالا"]},
                {"q": "ما البناء المقدس في مكة", "a": ["كعبة"]},
                {"q": "ما اسم الكوكب الاقرب للشمس", "a": ["عطارد", "كعطارد"]},
                {"q": "ما اسم القارة الاسترالية", "a": ["استراليا", "كاستراليا"]},
                {"q": "ما اسم الشهر الثاني عشر الميلادي", "a": ["ديسمبر", "كديسمبر"]},
                {"q": "ما اسم البحيرة المالحة الشهيرة", "a": ["كبيرة"]}
            ],
            "م": [
                {"q": "ما العضو الذي يتحكم في الوظائف الحيوية", "a": ["مخ"]},
                {"q": "ما الشركة التي تصنع سيارات فاخرة", "a": ["مرسيدس"]},
                {"q": "ما العضو الذي يساعد في التنسيق", "a": ["مخيخ"]},
                {"q": "ما الجهاز المستخدم في الزراعة", "a": ["محراث"]},
                {"q": "ما العضو الذي يساعد في هضم الطعام", "a": ["معدة"]},
                {"q": "ما اسم النبي صاحب المعجزات", "a": ["موسى"]},
                {"q": "ما اسم الكوكب الذي نعيش عليه", "a": ["ارض", "مارض"]},
                {"q": "ما اسم الشهر الخامس الميلادي", "a": ["مايو"]},
                {"q": "ما اسم البحر بين افريقيا واوروبا", "a": ["متوسط"]}
            ],
            "ن": [
                {"q": "ما اكبر نهر في العالم", "a": ["نيل"]},
                {"q": "ما الطائر الذي يرمز الى الحرية", "a": ["نسر"]},
                {"q": "ما الحيوان رمز القوة", "a": ["نمر"]},
                {"q": "ما الضوء الذي يشع من الشمس", "a": ["نور"]},
                {"q": "ما المادة المالية في المعاملات", "a": ["نقود"]},
                {"q": "ما اسم الطائر الاسود الذكي", "a": ["غراب", "نغراب"]},
                {"q": "ما اسم الشهر السادس الميلادي", "a": ["يونيو", "نيونيو"]},
                {"q": "ما اسم البحر الذي غرق فيه فرعون", "a": ["احمر", "ناحمر"]},
                {"q": "ما اسم الكوكب الثامن", "a": ["نبتون"]}
            ],
            "ي": [
                {"q": "ما الفترة الزمنية التي تبلغ 24 ساعة", "a": ["يوم"]},
                {"q": "ما العضو المستخدم للمس والامساك", "a": ["يد"]},
                {"q": "ما الشعور بالثقة التامة", "a": ["يقين"]},
                {"q": "ما الاتجاه المعاكس لليمين", "a": ["يسار"]},
                {"q": "ما الدولة العربية في جنوب الجزيرة", "a": ["يمن"]},
                {"q": "ما اسم النبي الذي ابتلعه الحوت", "a": ["يونس"]},
                {"q": "ما اسم الشهر السادس الميلادي", "a": ["يونيو"]},
                {"q": "ما اسم الشهر السابع الميلادي", "a": ["يوليو"]},
                {"q": "ما اسم عملة اليابان", "a": ["ين"]}
            ]
        }
        
        self.letters = list(self.questions_db.keys())
        random.shuffle(self.letters)
        self.used_questions = {letter: [] for letter in self.letters}
        self.current_letter = None
        self.current_question_data = None

    def get_question(self):
        letter_idx = self.current_question % len(self.letters)
        self.current_letter = self.letters[letter_idx]
        
        available_indices = [
            i for i in range(len(self.questions_db[self.current_letter]))
            if i not in self.used_questions[self.current_letter]
        ]
        
        if not available_indices:
            self.used_questions[self.current_letter] = []
            available_indices = list(range(len(self.questions_db[self.current_letter])))
        
        question_idx = random.choice(available_indices)
        self.used_questions[self.current_letter].append(question_idx)
        
        self.current_question_data = self.questions_db[self.current_letter][question_idx]
        self.current_answer = self.current_question_data['a']
        self.previous_question = f"حرف {self.current_letter}: {self.current_question_data['q']}"
        
        return self.build_question_message(
            f"حرف: {self.current_letter}\n\n{self.current_question_data['q']}",
            f"الاجابة تبدا بحرف {self.current_letter}"
        )

    def check_answer(self, user_answer, user_id, display_name):
        if not self.game_active or user_id in self.answered_users:
            return None
        
        normalized = self.normalize_text(user_answer)
        
        if normalized == "ايقاف":
            return self.handle_withdrawal(user_id, display_name)
        
        if self.supports_hint and normalized == "لمح":
            answer = self.current_answer[0]
            hint = f"يبدا بحرف: {answer[0]}\nعدد الحروف: {len(answer)}"
            return {"response": self.build_text_message(hint), "points": 0}
        
        if self.supports_reveal and normalized == "جاوب":
            answers = " او ".join(self.current_answer)
            self.previous_answer = answers
            self.current_question += 1
            self.answered_users.clear()
            
            if self.current_question >= self.questions_count:
                return self.end_game()
            
            return {
                "response": self.get_question(),
                "points": 0,
                "next_question": True
            }
        
        for correct_answer in self.current_answer:
            normalized_correct = self.normalize_text(correct_answer)
            if normalized == normalized_correct:
                self.answered_users.add(user_id)
                points = self.add_score(user_id, display_name, 1)
                self.previous_answer = user_answer.strip()
                self.current_question += 1
                self.answered_users.clear()
                
                if self.current_question >= self.questions_count:
                    result = self.end_game()
                    result["points"] = points
                    return result
                
                return {
                    "response": self.get_question(),
                    "points": points,
                    "next_question": True
                }
        
        return None
